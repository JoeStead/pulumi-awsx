version: 3

vars:
  CWD:
    sh: pwd
  VERSION:
    sh: pulumictl get version
  PKG_ARGS: --no-bytecode --public-packages "*" --public

tasks:
  schemagen:
    cmds:
      - go build -o ../bin/pulumi-gen-awsx ./cmd/pulumi-gen-awsx
    dir: schemagen
    generates:
      - ../bin/pulumi-gen-awsx
    sources:
      - "**/*"
    
  schema:
    cmds:
      - bin/pulumi-gen-awsx schema awsx
    deps:
      - schemagen
    generates:
      - awsx/schema.json
    sources:
      - bin/pulumi-gen-awsx

  provider:install:
    cmds:
      - yarn install
    dir: awsx
    generates:
      - node_modules/**/*
    sources:
      - package.json
      - yarn.lock

  provider:gen:
    cmds:
      - yarn gen-types
    deps:
      - provider:install
      - schema
    dir: awsx
    generates:
      - schema-types.ts
    sources:
      - schema.json
      - scripts/generate-provider-types.ts

  provider:transpile:
    cmds:
      - yarn tsc
      - cp package.json schema.json ./bin/
      - sed -i.bak -e "s/\${VERSION}/{{ .VERSION }}/g" ./bin/package.json
    deps:
      - provider:install
      - provider:gen
    dir: awsx
    generates:
      - bin/**/*
    sources:
      - "**/*.ts"
      - "*.*"

  provider:build:
    cmds:
      - yarn run pkg . {{ .PKG_ARGS }} --target node16 --output ../bin/pulumi-resource-awsx
    deps:
      - provider:transpile
    dir: awsx
    generates:
      - ../bin/pulumi-resource-awsx
    sources:
      - bin/**/*
      - "*"
